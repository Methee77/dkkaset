// Project Choice App
// Single-file React app (App.jsx) using Tailwind CSS and Firebase (Firestore + Auth)
// Instructions:
// 1) Create a new Vite React project (or CRA) and add Tailwind.
//    npx create-vite@latest project-choice --template react
//    cd project-choice
//    npm install
// 2) Install dependencies:
//    npm install firebase
// 3) Set up Tailwind (follow Tailwind docs for Vite).
// 4) Create a file src/App.jsx and paste this code.
// 5) Create a file src/firebaseConfig.js with your Firebase config (see below).
// 6) In Firebase Console:
//    - Enable Firestore (in test mode for development or set rules).
//    - Enable Email/Password Authentication.
//    - Create an admin user account (email/password) that will be allowed to access admin panel.
// 7) Start dev server: npm run dev

/* ---------- src/firebaseConfig.js (create this file and export your config) ----------
export const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Optionally export an array of allowed admin emails: export const ALLOWED_ADMINS = ["admin@your.edu"];
*/

import React, { useEffect, useState } from "react";
import { initializeApp } from "firebase/app";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  getDocs,
  deleteDoc,
  doc
} from "firebase/firestore";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "firebase/auth";
import { firebaseConfig as userConfig, ALLOWED_ADMINS } from "./firebaseConfig";

// Initialize Firebase
const app = initializeApp(userConfig);
const db = getFirestore(app);
const auth = getAuth(app);

export default function App() {
  const [view, setView] = useState("form"); // 'form' or 'admin'

  return (
    <div className="min-h-screen bg-white text-gray-900 flex items-start justify-center p-6">
      <div className="w-full max-w-4xl">
        <header className="mb-6">
          <h1 className="text-2xl font-semibold">ระบบเลือกร่วมโครงการนิสิต</h1>
          <p className="text-sm text-gray-600 mt-1">มินิมอล — ขาวสะอาด — Responsive</p>
        </header>

        <main className="bg-white shadow-sm rounded-lg p-6">
          <nav className="flex gap-3 mb-4">
            <button onClick={() => setView("form")} className={`px-3 py-1 rounded ${view === "form" ? "bg-gray-100" : "bg-white"}`}>หน้าสำหรับนิสิต</button>
            <button onClick={() => setView("admin")} className={`px-3 py-1 rounded ${view === "admin" ? "bg-gray-100" : "bg-white"}`}>หน้าผู้ดูแล</button>
          </nav>

          {view === "form" ? <StudentForm /> : <AdminPanel />}
        </main>

        <footer className="text-xs text-gray-500 mt-4">ออกแบบโดย: ทีมงาน — ปรับแต่งตามต้องการ</footer>
      </div>
    </div>
  );
}

function StudentForm() {
  const [form, setForm] = useState({
    studentId: "",
    firstName: "",
    lastName: "",
    faculty: "",
    year: "",
    phone: "",
    email: "",
    project: ""
  });

  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState("");
  const projects = [
    "โครงการ A: พัฒนาโปรแกรม",
    "โครงการ B: งานสังคม",
    "โครงการ C: วิจัยนวัตกรรม",
    "โครงการ D: ฝึกงานภาคสนาม"
  ];

  function update(field, value) {
    setForm(prev => ({ ...prev, [field]: value }));
  }

  async function handleSubmit(e) {
    e.preventDefault();
    setLoading(true);
    try {
      // basic validation
      if (!form.studentId || !form.firstName || !form.project) {
        setSuccess("กรุณากรอกข้อมูลให้ครบ (รหัส, ชื่อ, เลือกโครงการ)");
        setLoading(false);
        return;
      }

      const col = collection(db, "submissions");
      await addDoc(col, {
        ...form,
        createdAt: serverTimestamp()
      });

      setSuccess("ส่งข้อมูลเรียบร้อยแล้ว ขอบคุณครับ");
      setForm({ studentId: "", firstName: "", lastName: "", faculty: "", year: "", phone: "", email: "", project: "" });
    } catch (err) {
      console.error(err);
      setSuccess("เกิดข้อผิดพลาดในการส่งข้อมูล");
    } finally {
      setLoading(false);
      setTimeout(() => setSuccess(""), 4000);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <Input label="รหัสนิสิต" value={form.studentId} onChange={v => update("studentId", v)} />
        <Input label="ชื่อ" value={form.firstName} onChange={v => update("firstName", v)} />
        <Input label="นามสกุล" value={form.lastName} onChange={v => update("lastName", v)} />
      </div>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        <Input label="คณะ" value={form.faculty} onChange={v => update("faculty", v)} />
        <Input label="ปีการศึกษา" value={form.year} onChange={v => update("year", v)} />
        <Input label="เบอร์โทร" value={form.phone} onChange={v => update("phone", v)} />
      </div>

      <Input label="อีเมล (ไม่บังคับ)" value={form.email} onChange={v => update("email", v)} />

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">เลือกโครงการ (หนึ่งตัวเลือก)</label>
        <div className="space-y-2">
          {projects.map(p => (
            <label key={p} className="flex items-center gap-2">
              <input type="radio" name="project" checked={form.project === p} onChange={() => update("project", p)} />
              <span className="text-sm">{p}</span>
            </label>
          ))}
        </div>
      </div>

      <div className="flex items-center gap-3">
        <button type="submit" disabled={loading} className="px-4 py-2 rounded border">{loading ? "กำลังส่ง..." : "ส่งข้อมูล"}</button>
        {success && <div className="text-sm text-green-600">{success}</div>}
      </div>
    </form>
  );
}

function Input({ label, value, onChange }) {
  return (
    <label className="block">
      <span className="text-sm text-gray-700">{label}</span>
      <input value={value} onChange={e => onChange(e.target.value)} className="mt-1 block w-full border rounded px-3 py-2" />
    </label>
  );
}

function AdminPanel() {
  const [user, setUser] = useState(null);
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [submissions, setSubmissions] = useState([]);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, u => {
      setUser(u);
      if (u) fetchSubmissions();
    });
    return unsub;
  }, []);

  async function handleLogin(e) {
    e.preventDefault();
    setError("");
    try {
      const cred = await signInWithEmailAndPassword(auth, email, password);
      // check allowed admin
      if (ALLOWED_ADMINS && Array.isArray(ALLOWED_ADMINS) && !ALLOWED_ADMINS.includes(cred.user.email)) {
        setError("บัญชีนี้ไม่มีสิทธิ์เป็นผู้ดูแล");
        await signOut(auth);
        return;
      }
    } catch (err) {
      console.error(err);
      setError("ไม่สามารถเข้าสู่ระบบ: ตรวจสอบอีเมล/รหัสผ่าน");
    }
  }

  async function fetchSubmissions() {
    setLoading(true);
    try {
      const q = query(collection(db, "submissions"), orderBy("createdAt", "desc"));
      const snap = await getDocs(q);
      const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setSubmissions(rows);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete(id) {
    if (!confirm("ลบรายการนี้จริงหรือไม่?")) return;
    try {
      await deleteDoc(doc(db, "submissions", id));
      setSubmissions(prev => prev.filter(r => r.id !== id));
    } catch (err) {
      console.error(err);
      alert("ไม่สามารถลบได้");
    }
  }

  function downloadCSV() {
    if (submissions.length === 0) return;
    const keys = ["studentId","firstName","lastName","faculty","year","phone","email","project","createdAt"];
    const rows = submissions.map(s => keys.map(k => {
      let v = s[k] ?? "";
      if (k === "createdAt" && v && v.seconds) {
        v = new Date(v.seconds * 1000).toLocaleString();
      }
      // escape quotes
      return `"${String(v).replace(/"/g, '""')}"`;
    }).join(","));

    const header = keys.join(",");
    const csv = [header, ...rows].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `submissions_${new Date().toISOString()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  if (!user) {
    return (
      <div>
        <h2 className="text-lg font-medium mb-2">เข้าสู่ระบบผู้ดูแล</h2>
        <form onSubmit={handleLogin} className="space-y-3 max-w-sm">
          <label className="block"><span className="text-sm">อีเมล</span><input value={email} onChange={e=>setEmail(e.target.value)} className="mt-1 block w-full border rounded px-3 py-2" /></label>
          <label className="block"><span className="text-sm">รหัสผ่าน</span><input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="mt-1 block w-full border rounded px-3 py-2" /></label>
          <div className="flex gap-2">
            <button className="px-3 py-2 rounded border">เข้าสู่ระบบ</button>
            <button type="button" onClick={fetchSubmissions} className="px-3 py-2 rounded border">รีเฟรช</button>
          </div>
          {error && <div className="text-sm text-red-600">{error}</div>}
        </form>
      </div>
    );
  }

  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-lg font-medium">แผงผู้ดูแล</h2>
        <div className="flex gap-2">
          <button onClick={downloadCSV} className="px-3 py-2 rounded border">ดาวน์โหลด CSV</button>
          <button onClick={async ()=>{await signOut(auth);setUser(null)}} className="px-3 py-2 rounded border">ออกจากระบบ</button>
        </div>
      </div>

      {loading ? <div>กำลังโหลด...</div> : (
        <div className="overflow-auto">
          <table className="w-full text-sm border-collapse">
            <thead className="text-left">
              <tr>
                <th className="p-2 border-b">รหัส</th>
                <th className="p-2 border-b">ชื่อ</th>
                <th className="p-2 border-b">คณะ/ปี</th>
                <th className="p-2 border-b">โครงการ</th>
                <th className="p-2 border-b">เวลา</th>
                <th className="p-2 border-b">จัดการ</th>
              </tr>
            </thead>
            <tbody>
              {submissions.map(s => (
                <tr key={s.id} className="align-top">
                  <td className="p-2 border-b">{s.studentId}</td>
                  <td className="p-2 border-b">{s.firstName} {s.lastName}<div className="text-xs text-gray-500">{s.email}</div></td>
                  <td className="p-2 border-b">{s.faculty} / {s.year}</td>
                  <td className="p-2 border-b">{s.project}</td>
                  <td className="p-2 border-b">{s.createdAt && s.createdAt.seconds ? new Date(s.createdAt.seconds*1000).toLocaleString() : '-'}</td>
                  <td className="p-2 border-b"><button onClick={()=>handleDelete(s.id)} className="px-2 py-1 rounded border text-sm">ลบ</button></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

/* Notes & Security
 - For production, secure Firestore rules so only authenticated admins can read/delete the 'submissions' collection.
 - Example rule (simplified):
    match /databases/{database}/documents {
      match /submissions/{doc} {
        allow create: if true; // allow students to submit
        allow read, delete: if request.auth != null && request.auth.token.email in ['admin@...'];
      }
    }
 - Do NOT store admin emails or secrets in client-side code in production. Use a proper backend or Cloud Functions for admin actions if needed.
*/
